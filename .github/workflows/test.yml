name: Test and Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: Terraform Format Check
        working-directory: ./terraform
        run: terraform fmt -check -recursive
      
      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init -backend=false
      
      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate
  
  validate-python:
    name: Validate Python Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies for Service A
        working-directory: ./services/service-a
        run: |
          pip install -r requirements.txt
      
      - name: Check Python syntax - Service A
        working-directory: ./services/service-a
        run: python -m py_compile app.py
      
      - name: Install dependencies for Service B
        working-directory: ./services/service-b
        run: |
          pip install -r requirements.txt
      
      - name: Check Python syntax - Service B
        working-directory: ./services/service-b
        run: python -m py_compile app.py
  
  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Service A
        uses: docker/build-push-action@v5
        with:
          context: ./services/service-a
          push: false
          tags: service-a:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build Service B
        uses: docker/build-push-action@v5
        with:
          context: ./services/service-b
          push: false
          tags: service-b:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
  
  lint-dockerfile:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Lint Service A Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: services/service-a/Dockerfile
      
      - name: Lint Service B Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: services/service-b/Dockerfile
  
  validate-yaml:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate GitHub Actions workflows
        run: |
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              python -c "import yaml; yaml.safe_load(open('$file'))"
            fi
          done
  
  check-scripts:
    name: Check Shell Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check script permissions
        run: |
          ls -la scripts/
          test -x scripts/setup-backend.sh
          test -x scripts/push-images.sh
          test -x scripts/test-services.sh
      
      - name: Validate shell scripts with shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck scripts/*.sh || true
  
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [validate-terraform, validate-python, build-docker-images, lint-dockerfile, validate-yaml, check-scripts]
    
    steps:
      - name: Test Summary
        run: |
          echo "All validation tests passed successfully!"
          echo ""
          echo "Validated:"
          echo "- Terraform configuration"
          echo "- Python applications"
          echo "- Docker images build"
          echo "- Dockerfile linting"
          echo "- YAML syntax"
          echo "- Shell scripts"
          echo ""
          echo "Project is ready for deployment!"
